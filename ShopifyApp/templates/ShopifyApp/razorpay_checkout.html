{% extends 'ShopifyApp/base.html' %}
{% block body %}
<div class="container mt-4 text-center">
  <h3>Pay â‚¹{{ order.total_price }} for Order #{{ order.id }}</h3>
  <button id="rzp-button" class="btn btn-primary mt-3">Pay with Razorpay</button>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
var options = {
    "key": "{{ razorpay_key_id }}",
    "amount": "{{ amount }}", // in paise
    "currency": "INR",
    "name": "Shopify",
    "description": "Order #{{ order.id }}",
    "order_id": "{{ razorpay_order_id }}",
    "handler": function (response){
        // send payment details to server to verify
        fetch("{% url 'app:razorpay-verify' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: new URLSearchParams({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                order_id: "{{ order.id }}"
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                window.location.href = "{% url 'app:order-success' order.id %}";
            } else {
                alert('Payment verification failed');
            }
        });
    },
    "prefill": {
        "name": "{{ request.user.username }}",
    },
    "theme": { "color": "#3399cc" }
};
var rzp = new Razorpay(options);
document.getElementById('rzp-button').onclick = function(e){
    rzp.open();
    e.preventDefault();
}
</script>
{% endblock %}
